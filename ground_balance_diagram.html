<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ground Balance Process Diagram</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: white;
            padding: 40px;
            max-width: 1600px;
            margin: 0 auto;
        }
        .title {
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #000;
        }
        .subtitle {
            text-align: center;
            font-size: 18px;
            color: #555;
            margin-bottom: 40px;
        }
        .section {
            margin: 30px 0;
            padding: 25px;
            border: 3px solid #333;
            border-radius: 10px;
        }
        .section-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            color: white;
            padding: 12px;
            border-radius: 6px;
        }
        .problem-section .section-title {
            background: #d32f2f;
        }
        .modes-section .section-title {
            background: #1976d2;
        }
        .manual-section .section-title {
            background: #388e3c;
        }
        .auto-section .section-title {
            background: #f57c00;
        }
        .math-section .section-title {
            background: #7b1fa2;
        }
        .box {
            border: 2px solid #000;
            padding: 18px;
            margin: 15px auto;
            text-align: center;
            border-radius: 8px;
            background: #fff;
            font-weight: bold;
            max-width: 450px;
        }
        .box.problem {
            background: #ffebee;
            border-color: #c62828;
        }
        .box.solution {
            background: #e8f5e9;
            border-color: #2e7d32;
        }
        .box.mode {
            background: #e3f2fd;
            border-color: #1976d2;
        }
        .box.process {
            background: #fff3e0;
            border-color: #f57c00;
        }
        .box.output {
            background: #f3e5f5;
            border-color: #7b1fa2;
        }
        .arrow {
            text-align: center;
            font-size: 28px;
            margin: 12px 0;
            color: #000;
        }
        .label {
            text-align: center;
            font-style: italic;
            color: #555;
            margin: 10px 0;
            font-size: 15px;
        }
        .flow-container {
            display: flex;
            justify-content: space-around;
            margin: 25px 0;
            gap: 20px;
        }
        .flow-column {
            flex: 1;
        }
        .formula {
            background: #f0f0f0;
            border: 2px dashed #666;
            border-radius: 8px;
            padding: 15px;
            margin: 15px auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-width: 700px;
        }
        .vector-diagram {
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 30px;
            margin: 20px auto;
            width: 500px;
            height: 400px;
            position: relative;
        }
        .vector-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
            font-size: 16px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 2px solid #333;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #1976d2;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        .code-ref {
            background: #e1f5fe;
            border: 2px solid #0277bd;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .timeline {
            position: relative;
            padding: 30px 0;
            margin: 20px 0;
        }
        .timeline-item {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }
        .timeline-number {
            background: #1976d2;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            flex-shrink: 0;
        }
        .timeline-content {
            margin-left: 20px;
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #1976d2;
            flex: 1;
        }
        .warning-box {
            background: #fff3e0;
            border: 3px solid #f57c00;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .warning-box h4 {
            margin-top: 0;
            color: #f57c00;
        }
        .comparison {
            display: flex;
            gap: 20px;
            margin: 25px 0;
        }
        .comparison-item {
            flex: 1;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid;
        }
        .comparison-item.before {
            background: #ffebee;
            border-color: #c62828;
        }
        .comparison-item.after {
            background: #e8f5e9;
            border-color: #2e7d32;
        }
        .comparison-item h3 {
            margin-top: 0;
        }
        svg {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="title">GROUND BALANCE PROCESS</div>
    <div class="subtitle">Mineralized Soil Cancellation for Metal Detectors</div>

    <!-- THE PROBLEM -->
    <div class="section problem-section">
        <div class="section-title">THE PROBLEM: Why Ground Balance is Needed</div>

        <div class="comparison">
            <div class="comparison-item before">
                <h3>Without Ground Balance</h3>
                <p><strong>Ground minerals</strong> (iron oxides, salts, clay) produce constant signals that:</p>
                <ul>
                    <li>Overwhelm weak target signals</li>
                    <li>Create false "metal" responses</li>
                    <li>Vary with coil height and ground type</li>
                    <li>Change with temperature and moisture</li>
                </ul>
                <p><strong>Result:</strong> Can't detect small/deep targets through the noise</p>
            </div>

            <div class="comparison-item after">
                <h3>With Ground Balance</h3>
                <p><strong>Ground signal is nulled</strong> by measuring and subtracting the baseline:</p>
                <ul>
                    <li>Only target signals remain</li>
                    <li>Improved depth on small targets</li>
                    <li>Stable operation over varying ground</li>
                    <li>Reduced false signals</li>
                </ul>
                <p><strong>Result:</strong> Clean target detection in mineralized soil</p>
            </div>
        </div>

        <div class="warning-box">
            <h4>Key Insight</h4>
            <p>Ground minerals produce a <strong>constant I/Q vector</strong> at each frequency. By measuring this vector
            and subtracting it from all readings, we cancel the ground signal while preserving target signals.</p>
        </div>
    </div>

    <!-- FOUR MODES -->
    <div class="section modes-section">
        <div class="section-title">FOUR GROUND BALANCE MODES</div>

        <table>
            <tr>
                <th>Mode</th>
                <th>Description</th>
                <th>Best For</th>
                <th>Behavior</th>
            </tr>
            <tr>
                <td><strong>OFF</strong></td>
                <td>No ground balance applied</td>
                <td>Clean beaches, air tests</td>
                <td>Raw signal passed through</td>
            </tr>
            <tr>
                <td><strong>MANUAL</strong></td>
                <td>"Pump and set" - user captures ground baseline</td>
                <td>Stable ground, maximum control</td>
                <td>Fixed baseline until manually reset</td>
            </tr>
            <tr>
                <td><strong>AUTO_TRACKING</strong></td>
                <td>Automatically adapts to ground changes</td>
                <td>Variable ground, ease of use</td>
                <td>Slow IIR filter (α=0.0005), freezes on targets</td>
            </tr>
            <tr>
                <td><strong>MANUAL_TRACKING</strong></td>
                <td>Manual preset + auto-tracking adjustments</td>
                <td>Hot ground with drift</td>
                <td>Starts with manual, then slowly tracks changes</td>
            </tr>
        </table>

        <div class="code-ref">GroundBalanceManager.kt:9-14 - GroundBalanceMode enum</div>
    </div>

    <!-- MANUAL MODE PROCESS -->
    <div class="section manual-section">
        <div class="section-title">MANUAL MODE: "Pump and Set" Process</div>

        <div class="timeline">
            <div class="timeline-item">
                <div class="timeline-number">1</div>
                <div class="timeline-content">
                    <strong>User starts capture</strong><br>
                    Calls startManualCapture(), clears previous samples<br>
                    <span class="code-ref">GroundBalanceManager.kt:81</span>
                </div>
            </div>

            <div class="timeline-item">
                <div class="timeline-number">2</div>
                <div class="timeline-content">
                    <strong>User "pumps" coil</strong><br>
                    Moves coil up/down over ground 10 times<br>
                    Each audio callback captures IQ analysis<br>
                    Samples stored in captureSamples list
                </div>
            </div>

            <div class="timeline-item">
                <div class="timeline-number">3</div>
                <div class="timeline-content">
                    <strong>User stops capture</strong><br>
                    Calls stopManualCapture()<br>
                    <span class="code-ref">GroundBalanceManager.kt:89</span>
                </div>
            </div>

            <div class="timeline-item">
                <div class="timeline-number">4</div>
                <div class="timeline-content">
                    <strong>Calculate average baseline</strong><br>
                    Average I/Q components across all 10 samples, per frequency<br>
                    <span class="code-ref">GroundBalanceManager.kt:267 - averageCapturedSamples()</span>
                </div>
            </div>

            <div class="timeline-item">
                <div class="timeline-number">5</div>
                <div class="timeline-content">
                    <strong>Store baseline</strong><br>
                    manualBaseline = List&lt;GroundBalancePoint&gt;<br>
                    One point per frequency with I, Q, amplitude, phase
                </div>
            </div>
        </div>

        <div class="formula">
            <strong>Averaging Formula (per frequency):</strong><br><br>
            For each frequency f:<br>
            &nbsp;&nbsp;avgI[f] = (I₁ + I₂ + ... + I₁₀) / 10<br>
            &nbsp;&nbsp;avgQ[f] = (Q₁ + Q₂ + ... + Q₁₀) / 10<br>
            &nbsp;&nbsp;avgAmp[f] = √(avgI² + avgQ²)<br>
            &nbsp;&nbsp;avgPhase[f] = atan2(avgQ, avgI)<br><br>
            <strong>Result:</strong> GroundBalancePoint(freq, avgI, avgQ, avgAmp, avgPhase)
        </div>

        <div class="warning-box">
            <h4>Why Pump the Coil?</h4>
            <p>Pumping averages out variations in:</p>
            <ul>
                <li>Coil height (distance changes I/Q magnitude)</li>
                <li>Ground mineral distribution (not perfectly uniform)</li>
                <li>Electronic noise</li>
            </ul>
            <p>Result: More stable baseline = better ground cancellation</p>
        </div>
    </div>

    <!-- AUTO-TRACKING MODE -->
    <div class="section auto-section">
        <div class="section-title">AUTO-TRACKING MODE: Continuous Adaptation</div>

        <div class="box process">IIR Low-Pass Filter<br>(α = 0.0005 = 0.05%)</div>

        <div class="formula">
            <strong>Tracking Update Formula (every audio callback):</strong><br><br>
            baseline[n] = α × current[n] + (1 - α) × baseline[n-1]<br><br>
            Where:<br>
            &nbsp;&nbsp;α = 0.0005 (very slow tracking)<br>
            &nbsp;&nbsp;current = latest IQ measurement<br>
            &nbsp;&nbsp;baseline = tracking baseline<br><br>
            <strong>Time Constant:</strong><br>
            At 23.2 Hz callback rate: τ ≈ 1/(23.2 × 0.0005) ≈ 86 seconds<br>
            Takes ~86 seconds to adapt 63% to ground changes
        </div>

        <div class="code-ref">GroundBalanceManager.kt:188 - updateTrackingBaseline()</div>

        <div class="warning-box">
            <h4>Target Detection & Freeze</h4>
            <p><strong>Problem:</strong> If tracking continues during target detection, it will try to "null out" the target!</p>
            <p><strong>Solution:</strong> Freeze tracking when strong signal detected</p>
            <div class="formula" style="margin-top: 10px;">
                if (maxAmplitude > 0.3) {<br>
                &nbsp;&nbsp;trackingFrozen = true<br>
                &nbsp;&nbsp;// Don't update baseline<br>
                } else {<br>
                &nbsp;&nbsp;trackingFrozen = false<br>
                &nbsp;&nbsp;// Continue slow tracking<br>
                }
            </div>
            <span class="code-ref">GroundBalanceManager.kt:189-196</span>
        </div>

        <div class="box process">
            <strong>Auto-Tracking Behavior:</strong><br><br>
            • Initializes on first reading<br>
            • Slowly follows ground changes<br>
            • Freezes when amplitude > 0.3<br>
            • Resumes tracking when target passes
        </div>
    </div>

    <!-- VECTOR SUBTRACTION MATH -->
    <div class="section math-section">
        <div class="section-title">BASELINE SUBTRACTION: Vector Math with Offset</div>

        <div class="vector-diagram">
            <div class="vector-title">I/Q Vector Subtraction (Before/After Ground Balance)</div>
            <svg viewBox="0 0 500 350">
                <!-- Axes -->
                <line x1="250" y1="0" x2="250" y2="350" stroke="#999" stroke-width="1"/>
                <line x1="0" y1="175" x2="500" y2="175" stroke="#999" stroke-width="1"/>
                <text x="480" y="170" font-size="14">I</text>
                <text x="255" y="15" font-size="14">Q</text>

                <!-- Ground baseline vector (red) -->
                <defs>
                    <marker id="arrowRed" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#c62828"/>
                    </marker>
                    <marker id="arrowBlue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#1976d2"/>
                    </marker>
                    <marker id="arrowGreen" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#2e7d32"/>
                    </marker>
                </defs>

                <!-- Ground baseline (red) -->
                <line x1="250" y1="175" x2="370" y2="95" stroke="#c62828" stroke-width="4" marker-end="url(#arrowRed)"/>
                <text x="320" y="125" fill="#c62828" font-weight="bold">Ground Baseline</text>

                <!-- Signal with ground (blue) -->
                <line x1="250" y1="175" x2="400" y2="75" stroke="#1976d2" stroke-width="4" marker-end="url(#arrowBlue)"/>
                <text x="360" y="105" fill="#1976d2" font-weight="bold">Signal + Ground</text>

                <!-- Target only (green) = difference -->
                <line x1="370" y1="95" x2="400" y2="75" stroke="#2e7d32" stroke-width="4" marker-end="url(#arrowGreen)"/>
                <text x="385" y="70" fill="#2e7d32" font-weight="bold">Target Only</text>

                <!-- Labels -->
                <text x="20" y="340" font-size="12" fill="#555">Result: Green vector = Blue - Red</text>
                <text x="20" y="355" font-size="12" fill="#555">Ground signal cancelled, target signal preserved</text>
            </svg>
        </div>

        <div class="formula">
            <strong>Subtraction Formula (with offset adjustment):</strong><br><br>
            1. Apply offset as phase rotation to baseline:<br>
            &nbsp;&nbsp;offsetRadians = (offset / 50) × (π/4)<br>
            &nbsp;&nbsp;rotatedI = baseI × cos(offset) - baseQ × sin(offset)<br>
            &nbsp;&nbsp;rotatedQ = baseI × sin(offset) + baseQ × cos(offset)<br><br>
            2. Subtract rotated baseline from current signal:<br>
            &nbsp;&nbsp;newI = currentI - rotatedI<br>
            &nbsp;&nbsp;newQ = currentQ - rotatedQ<br><br>
            3. Calculate new amplitude and phase:<br>
            &nbsp;&nbsp;newAmplitude = √(newI² + newQ²)<br>
            &nbsp;&nbsp;newPhase = atan2(newQ, newI)
        </div>

        <div class="code-ref">GroundBalanceManager.kt:228 - subtractBaseline()</div>

        <div class="warning-box">
            <h4>GB Offset: User Fine-Tuning</h4>
            <p><strong>Offset Range:</strong> -50 to +50</p>
            <p><strong>Effect:</strong> Rotates the baseline vector by ±45°</p>
            <p><strong>Use Case:</strong></p>
            <ul>
                <li><strong>Positive offset:</strong> Reduces sensitivity to ground minerals (for very hot ground)</li>
                <li><strong>Negative offset:</strong> Increases sensitivity (for mild ground)</li>
                <li><strong>Zero offset:</strong> Neutral (exact baseline subtraction)</li>
            </ul>
            <p>This allows user to optimize the "null point" for their specific ground conditions.</p>
        </div>
    </div>

    <!-- COMPLETE FLOW -->
    <div class="section">
        <div class="section-title" style="background: #455a64; color: white;">COMPLETE GROUND BALANCE FLOW</div>

        <div class="box mode">IQ Analysis from Demodulator<br>List&lt;ToneAnalysis&gt;</div>
        <div class="arrow">↓</div>

        <div class="box mode">applyGroundBalance(analysis)</div>
        <div class="arrow">↓</div>

        <div class="flow-container">
            <div class="flow-column">
                <div class="box mode">Check Mode</div>
                <div class="label">OFF / MANUAL / AUTO /<br>MANUAL_TRACKING</div>
            </div>
            <div class="flow-column">
                <div class="box mode">Update Tracking?</div>
                <div class="label">If AUTO mode:<br>Update baseline (if not frozen)</div>
            </div>
            <div class="flow-column">
                <div class="box mode">Get Baseline</div>
                <div class="label">Manual or Tracking<br>baseline vector</div>
            </div>
        </div>

        <div class="arrow">↓</div>

        <div class="box process">Subtract Baseline with Offset<br>(Vector subtraction in I/Q space)</div>

        <div class="arrow">↓</div>

        <div class="box output">Ground-Balanced ToneAnalysis<br>(Clean target signal)</div>

        <div class="arrow">↓</div>

        <div class="box output">To VDI Calculator</div>

        <div class="code-ref">GroundBalanceManager.kt:154 - applyGroundBalance()</div>
    </div>

    <!-- COMPARISON TABLE -->
    <div class="section">
        <div class="section-title" style="background: #37474f; color: white;">MODE COMPARISON</div>

        <table>
            <tr>
                <th>Feature</th>
                <th>OFF</th>
                <th>MANUAL</th>
                <th>AUTO_TRACKING</th>
                <th>MANUAL_TRACKING</th>
            </tr>
            <tr>
                <td><strong>Setup Required</strong></td>
                <td>None</td>
                <td>Pump coil 10x</td>
                <td>None (auto-init)</td>
                <td>Pump coil, then auto</td>
            </tr>
            <tr>
                <td><strong>Adapts to Changes</strong></td>
                <td>N/A</td>
                <td>No</td>
                <td>Yes (slow)</td>
                <td>Yes (slow)</td>
            </tr>
            <tr>
                <td><strong>Target Freeze</strong></td>
                <td>N/A</td>
                <td>N/A</td>
                <td>Yes (amp > 0.3)</td>
                <td>Yes (amp > 0.3)</td>
            </tr>
            <tr>
                <td><strong>Best For</strong></td>
                <td>Air tests, beach</td>
                <td>Stable ground</td>
                <td>Variable ground</td>
                <td>Hot + drifting ground</td>
            </tr>
            <tr>
                <td><strong>Skill Level</strong></td>
                <td>Any</td>
                <td>Intermediate</td>
                <td>Beginner</td>
                <td>Advanced</td>
            </tr>
        </table>
    </div>

    <!-- KEY PARAMETERS -->
    <div class="section" style="background: #fff9c4;">
        <div class="section-title" style="background: #f57f17;">KEY PARAMETERS</div>

        <table>
            <tr>
                <th>Parameter</th>
                <th>Value</th>
                <th>Effect</th>
            </tr>
            <tr>
                <td><strong>Capture Samples</strong></td>
                <td>10 pumps</td>
                <td>More samples = better averaging, slower setup</td>
            </tr>
            <tr>
                <td><strong>Tracking Alpha (α)</strong></td>
                <td>0.0005</td>
                <td>Smaller = slower tracking, less target null-out</td>
            </tr>
            <tr>
                <td><strong>Freeze Threshold</strong></td>
                <td>0.3 amplitude</td>
                <td>Higher = more aggressive tracking near targets</td>
            </tr>
            <tr>
                <td><strong>Offset Range</strong></td>
                <td>-50 to +50</td>
                <td>±45° phase rotation of baseline vector</td>
            </tr>
            <tr>
                <td><strong>Time Constant (τ)</strong></td>
                <td>~86 seconds</td>
                <td>How fast auto-tracking adapts (63% convergence)</td>
            </tr>
        </table>
    </div>

</body>
</html>
